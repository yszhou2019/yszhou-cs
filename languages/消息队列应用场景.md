# 消息队列kafka



用的是kafka
上面这个文档里面有对应的producer和consumer的函数配置参数



## 基本概念

cluster也就是机房的机器
cluster运行的实际上就是消息队列
客户端中的生产者进程发送消息给机房，存储到消息队列中
客户端中的消费者进程从机房的消息队列中取出数据，然后消费

topic就是消息队列的名称
一个消息队列包含多个queue，每个queue都叫partition



## 生产者进程

cluster指定某某机房
topic应该指的是这个机房里面运行的消息队列的名称
topic指定消息队列的名称，一个消息队列由多个队列组成，其中的每个队列都叫partition

生产者发送消息的时候，需要指定自己回调函数
发送成功的callback
发送失败的callback



生产者进程可以同步发送、可以异步发送
异步发送->发送完毕调用callback
同步发送->发送完毕阻塞，等待返回结果
批量发送



## 消费者进程

cluster指定机房
topic指定消息队列





## batch

实际上就是producer的积少成多，发送req的时候，先不发送，暂存，然后批量发送
降低io，降低qps，从而增加集群吞吐

linger_ms，也就是req保存在batch中的最长时间，超出这个时间则立即发送不再等待





# 设计与实现





# 使用





## 使用场景

https://cloud.tencent.com/developer/article/1006035



### 概述

- 应用耦合：多应用间通过消息队列对同一消息进行处理，避免调用接口失败导致整个过程失败；
- 异步处理：多应用对消息队列中同一消息进行处理，应用间并发处理消息，相比串行处理，减少处理时间；
- 限流削峰：广泛应用于秒杀或抢购活动中，避免流量过大导致应用系统挂掉的情况；
- 消息驱动的系统：系统分为消息队列、消息生产者、消息消费者，生产者负责产生消息，消费者(可能有多个)负责对消息进行处理；



### 异步处理

> 背景：注册信息写入，耗时50 -> 发送邮件，耗时50 -> 发送短信，耗时50
> 全部完成，再返回客户端 共计耗时150
> 基本改进：写入 -> {发邮件，发短信} 共计耗时100
> 方案：写入库后，立刻返回客户端，耗时50，然后写入mq -> {发邮件，发短信} 耗时50
>
> 解决问题：不需要等待
>
> 问题特点：==执行完一部分流程之后，就可以提前返回，降低延迟==；其他部分交由mq消费服务来执行
> 改进：降低接口延迟，且服务效果不变



### 系统解耦

> 背景：下游服务的调用失败率高，延迟高，且上游阻塞等待下游返回结果，两个服务耦合，导致下游失败率传递到上游
> 方案：上游->写入mq ->下游读取消费
> 上游写入mq后立即返回，下游主动读取mq，执行真正的业务逻辑
> 解决问题：==上游系统写入mq后立即返回；下游系统定时消费mq，避免把高延迟、高出错问题传递给上游==



### 削峰限流（瞬时访问大）

> 背景：秒杀活动，瞬时量大，导致服务崩溃
> 方案：上游写mq->下游读取消费，生成反馈，下游返回请求到客户端
> 解决问题：
> 1 mq进行**缓冲**
> 2 队列长度可限制，队列长度超出一定数量的情况下，下游可以直接告知用户"售罄"
>
> 问题的本质，之前是上游主动调用业务下游，下游是被动的，服务器能否扛得住取决于流量
> 改用mq之后下游主动消费mq，就不会存在下游扛不住的问题了





## 模式

### 点对点

上游->mq->下游

下游消费mq后告知mq，删除已经消费的msg

> 消息生产者生产消息发送到**queue**中，然后消息消费者从queue中取出并且消费消息。这里要注意： 
> 消息被消费以后，queue中不再有存储，所以消息消费者不可能消费到已经被消费的消息。 
> Queue支持存在多个消费者，但是**对一个消息而言，只会有一个消费者可以消费**。 



### 发布订阅

基本上都是发布订阅

类似字节的kafka
特点：
1 数据是持久化存储的
2 一个topic可以被多个consumer group重复消费（同一个group则不允许重复消费）
3 group内部负载均衡

> 消息生产者（发布）将消息发布到**topic**中，同时有多个消息消费者（订阅）消费该消息。和点对点方式不同，**发布到topic的消息会被所有订阅者消费**。



使用场景细讲

https://cloud.tencent.com/developer/article/1006035



发布订阅细讲

https://blog.csdn.net/lizhitao/article/details/47723105



基础名词细讲

https://my.oschina.net/u/2983845/blog/3013858



其他

https://www.cnblogs.com/pxlsdz/p/14932745.html
